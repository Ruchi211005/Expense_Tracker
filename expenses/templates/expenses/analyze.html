<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Expense Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Expense Analysis</h2>
    <a href="{% url 'expense_list' %}" class="btn btn-secondary">Back to List</a>
  </div>

  <div class="row">
    <div class="col-md-6">
      <h5>Totals by Category</h5>
      <canvas id="categoryChart"></canvas>
      {% if not categories %}
        <p class="text-muted mt-2">No category data yet.</p>
      {% endif %}
    </div>

    <div class="col-md-6">
      <h5>Monthly Trend</h5>
      <canvas id="monthlyChart"></canvas>
      {% if not monthly %}
        <p class="text-muted mt-2">No monthly data yet.</p>
      {% endif %}
    </div>
  </div>

  <script>
    // Build labels & data for categories
    const catLabels = [
      {% for c in categories %}
        "{{ c.category__name|escapejs }}"{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    const catData = [
      {% for c in categories %}
        {{ c.total|floatformat:2 }}{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    // Only create chart if data exists
    if (catLabels.length > 0) {
      new Chart(document.getElementById('categoryChart'), {
        type: 'pie',
        data: {
          labels: catLabels,
          datasets: [{
            data: catData,
            // Chart.js will pick default colors; you can add backgroundColor array if you want
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // Build labels & data for monthly
    const monthLabels = [
      {% for m in monthly %}
        "{{ m.month|date:'M Y' }}"{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    const monthData = [
      {% for m in monthly %}
        {{ m.total|floatformat:2 }}{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    if (monthLabels.length > 0) {
      new Chart(document.getElementById('monthlyChart'), {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Total spent',
            data: monthData,
            fill: false,
            tension: 0.3,
            // Chart.js picks colors automatically for lines; can set borderColor if you like
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  </script>
</body>
</html>
